---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Comments from '../../components/Comments.astro';
import CodeCopyButton from '../../components/CodeCopyButton.astro';
import BackToTop from '../../components/BackToTop.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import JsonLd from '../../components/JsonLd.astro';
import { SITE_CONFIG } from '../../config';
import styles from '../../styles/prose.module.css';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const publishedPosts = posts
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

  return publishedPosts.map((post, index) => {
    const prevPost = publishedPosts[index + 1];
    const nextPost = publishedPosts[index - 1];

    return {
      params: { slug: post.slug },
      props: {
        post,
        prevPost: prevPost ? { slug: prevPost.slug, title: prevPost.data.title } : undefined,
        nextPost: nextPost ? { slug: nextPost.slug, title: nextPost.data.title } : undefined,
      },
    };
  });
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time (roughly 200 words per minute)
const words = post.body.split(/\s+/).length;
const readingTime = Math.ceil(words / 200);

const postUrl = `${SITE_CONFIG.SITE_URL}/posts/${post.slug}/`;
---

<BaseLayout
  title={`${post.data.title} | ${SITE_CONFIG.SITE_TITLE}`}
  description={post.data.description}
  articleDate={post.data.date}
  articleTags={post.data.tags}
>
  <JsonLd
    slot="head"
    type="BlogPosting"
    title={post.data.title}
    description={post.data.description}
    date={post.data.date}
    tags={post.data.tags}
    wordCount={words}
    url={postUrl}
  />
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">{post.data.title}</h1>
      <div class="post-meta">
        <time datetime={post.data.date.toISOString()}>{formattedDate}</time>
        <span class="separator">·</span>
        <span>{readingTime} min read</span>
        {post.data.tags && post.data.tags.length > 0 && (
          <>
            <span class="separator">·</span>
            <span class="tags">
              {post.data.tags.map((tag: string) => (
                <a href={`/tags/${tag}`} class="tag">#{tag}</a>
              ))}
            </span>
          </>
        )}
      </div>
    </header>

    {post.data.toc && <TableOfContents headings={headings} />}

    <div class={styles.prose} data-prose>
      <Content />
    </div>

    <PostNavigation prevPost={prevPost} nextPost={nextPost} />

    <Comments />
  </article>
  <CodeCopyButton />
  <BackToTop />
</BaseLayout>

<style>
  .post {
    max-width: var(--content-width);
  }

  .post-header {
    margin-bottom: var(--space-xl);
  }

  .post-title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.2;
    letter-spacing: -0.02em;
    margin: 0;
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .separator {
    color: var(--color-border);
  }

  .tags {
    display: flex;
    gap: var(--space-sm);
  }

  .tag {
    color: var(--color-text-muted);
    text-decoration: none;
  }

  .tag:hover {
    color: var(--color-accent);
  }
</style>

<script>
  // Make all external links open in new tab with security attributes
  document.querySelectorAll('[data-prose] a[href^="http"]').forEach((link) => {
    const anchor = link as HTMLAnchorElement;
    if (!anchor.href.includes('korya.dev')) {
      anchor.setAttribute('target', '_blank');
      anchor.setAttribute('rel', 'noopener noreferrer');
    }
  });

  // Add anchor links to h2 and h3 headings
  document.querySelectorAll('[data-prose] h2[id], [data-prose] h3[id]').forEach((heading) => {
    const anchor = document.createElement('a');
    anchor.href = `#${heading.id}`;
    anchor.className = 'heading-anchor';
    anchor.setAttribute('aria-label', `Link to ${heading.textContent}`);
    anchor.textContent = '#';
    heading.insertBefore(anchor, heading.firstChild);
  });
</script>
